# Introduction
Creating a basic infra to lean some concepts of infrastructure.

## Repository
1. Install **ansible-playbook** and **azure cli**.
2. Use **az login** command to choose the Azure account that you want to use.
3. Access **registry** folder.
4. Generate a SSH key pair to be used by your instance with the command `ssh-keygen -t RSA -b 4096 -f ./harbor` inside **registry** folder.
5. Run `ansible-playbook --verbose setup-harbor.yaml`.
6. After running it, get the output of **Show public IP for new VM** task. It is the public IP of the instance created.
7. In your Domain manager, create a new Domain Registry with the IP that was generated by the Ansible Playbook. The same domain needs to be set in **inventory** file.
8. Change [inventory](./registry/inventory/main.yml), and change the following values:

```yaml
# ansible all -m ping
all:
  vars:
    ansible_ssh_user: harbor
    harbor_admin: cncfdemo
    domain_name: YOUR_DOMAIN
    cert_admin_email: YOUR_EMAIL
  children:
    harbor:
      hosts:
        THE_VM_PUBLIC_IP
```

9. Run `ansible-playbook harbor-playbook.yml`
10. Log in into the repository using `docker login YOUR_DOMAIN`.
## Creating initial infrastructure
1. Create a config map with the following configurations:

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-configuration
  labels:
    app: postgres
  namespace: infra
data:
  POSTGRES_DB: backend
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
```

2. Run `kubectl create -f YOUR_CONFIG_MAP.yaml`.
3. Access **the cluster configuration folder** and run [postgres](./cluster/postgres.yml) with `kubectl create -f cluster/postgres.yml`

It will create a replica of postgress database pod and expose its port inside the Kubernetes cluster.
4. Still inside cluster folder, run [application](./cluster/application.yml) with `kubectl create -f cluster/application.yml` to create deploy the Golang application.
5. Create the proxy server by running `kubectl create -f cluster/proxy.yml`.
6. Add `backend.local` inside `/etc/hosts` poiting to `minikube ip`.
7. Use `curl http://backend.local/v1/users` to test your application.